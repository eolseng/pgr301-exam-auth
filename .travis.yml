language: java
jdk: openjdk11

services:
  - docker

env:
  global:
    # GCP Setup
    - PROJECT_NAME=pgr301-exam-auth
    - REGISTRY_HOSTNAME=eu.gcr.io
    - CLOUDSDK_CORE_DISABLE_PROMPTS=1

cache:
  directories:
    - ".autoconf"
    - "$HOME/.m2"
    - "$HOME/google-cloud-sdk/"

before_install:
  # Decrypt gcp_keyfile.json
  - openssl aes-256-cbc -K $encrypted_b8738be8a379_key -iv $encrypted_b8738be8a379_iv -in gcp_keyfile.json.enc -out gcp_keyfile.json -d
  # Install GCloud if not cached
  - bash ./scripts/install_gcloud
  - source $HOME/google-cloud-sdk/path.bash.inc
  # Authenticate gcloud with the Service Account
  - gcloud auth activate-service-account --key-file gcp_keyfile.json
  # Authenticate Docker with gcloud credentials
  - gcloud auth configure-docker $REGISTRY_HOSTNAME

# Disabled for faster testing of deployment to GCP registry
install: true
script: true

deploy:
  skip_cleanup: true
  provider: script
  script: bash ./scripts/deploy
  on:
    branch: master
